
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë°”ë‹¤ë”°ë¼ - í•´ì•ˆë„ë¡œ ë„ë¡œê²½ìœ  ê¸¸ì°¾ê¸°</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #top-bar { padding: 10px; background: #0077cc; color: white; display: flex; flex-direction: column; gap: 8px; }
    #inputs { display: flex; gap: 8px; }
    input { padding: 8px; width: 240px; }
    button { padding: 8px 16px; background: white; border: none; cursor: pointer; }
    #map { width: 100%; height: calc(100vh - 100px); }
  </style>
</head>
<body>
  <div id="top-bar">
    <div><b>ğŸš— ë°”ë‹¤ë”°ë¼ - ë„ë¡œ ê¸°ë°˜ í•´ì•ˆ ìš°íšŒ ê²½ë¡œ</b></div>
    <div id="inputs">
      <input id="start" type="text" placeholder="ì¶œë°œì§€ ì£¼ì†Œ">
      <input id="end" type="text" placeholder="ë„ì°©ì§€ ì£¼ì†Œ">
      <button onclick="searchRoute()">ê²½ë¡œ ê²€ìƒ‰</button>
    </div>
  </div>
  <div id="map"></div>
  <script>
    const map = new ol.Map({
      target: 'map',
      layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
      view: new ol.View({ center: ol.proj.fromLonLat([127.5, 36.5]), zoom: 7 })
    });
    let routeLayer, attractionLayer;

    function clearLayers() {
      if (routeLayer) map.removeLayer(routeLayer);
      if (attractionLayer) map.removeLayer(attractionLayer);
    }

    async function geocode(address) {
      const key = "FA346133-805B-3BB4-B8C2-372973E3A4ED";
      const url = `https://api.vworld.kr/req/address?service=address&request=getcoord&format=json&type=road&address=${encodeURIComponent(address)}&key=${key}`;
      const res = await fetch(url);
      const json = await res.json();
      const { x, y } = json.response.result?.point ?? {};
      return x && y ? [parseFloat(x), parseFloat(y)] : null;
    }

    async function fetchCoastline() {
      const res = await fetch("https://rpwjd99.github.io/coastal-drive/í•´ì•ˆì„ _êµ­ê°€ê¸°ë³¸ë„.geojson");
      return await res.json();
    }

    function findDetourPoint(start, end, coastGeoJSON) {
      const startLat = start[1], startLon = start[0], endLat = end[1], endLon = end[0];
      const sameLat = [], sameLon = [];

      coastGeoJSON.features.forEach(f => {
        const [lon, lat] = f.geometry.coordinates;
        if (Math.abs(lat - startLat) < 0.05 && (endLon > startLon ? lon > startLon : lon < startLon))
          sameLat.push([lon, lat]);
        if (Math.abs(lon - startLon) < 0.05 && (endLat > startLat ? lat > startLat : lat < startLat))
          sameLon.push([lon, lat]);
      });

      function dist(a, b) {
        return Math.sqrt((a[0]-b[0])**2 + (a[1]-b[1])**2);
      }

      let latClose = sameLat.sort((a,b)=>dist(start,a)-dist(start,b))[0];
      let lonClose = sameLon.sort((a,b)=>dist(start,a)-dist(start,b))[0];

      if (!latClose && !lonClose) return null;
      if (!latClose) return lonClose;
      if (!lonClose) return latClose;

      return dist(start, latClose) < dist(start, lonClose) ? latClose : lonClose;
    }

    async function getRoute(coords) {
      const apiKey = "5b3ce3597851110001cf62486d543846e80049df9c7a9e10ecef2953";
      const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
        method: "POST",
        headers: {
          "Authorization": apiKey,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ coordinates: coords })
      });
      return await res.json();
    }

    async function searchRoute() {
      clearLayers();
      const startText = document.getElementById("start").value;
      const endText = document.getElementById("end").value;
      const start = await geocode(startText);
      const end = await geocode(endText);
      if (!start || !end) return alert("ì •í™•í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      const coast = await fetchCoastline();
      const waypoint = findDetourPoint(start, end, coast);
      if (!waypoint) return alert("í•´ì•ˆ ìš°íšŒ ì§€ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

      const routeGeoJSON = await getRoute([start, waypoint, end]);
      const features = new ol.format.GeoJSON().readFeatures(routeGeoJSON, { featureProjection: 'EPSG:3857' });
      routeLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features }),
        style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: '#0077cc', width: 4 }) })
      });
      map.addLayer(routeLayer);
      map.getView().fit(routeLayer.getSource().getExtent(), { padding: [50, 50, 50, 50] });
    }
  </script>
</body>
</html>
