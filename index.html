
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>바다따라 - 해안도로 감성 길찾기</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css" />
  <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #top-bar { padding: 10px; background: #0077cc; color: white; display: flex; flex-direction: column; gap: 8px; }
    #inputs { display: flex; gap: 8px; }
    input { padding: 8px; width: 240px; }
    button { padding: 8px 16px; background: white; border: none; cursor: pointer; }
    #map { width: 100%; height: calc(100vh - 100px); }
  </style>
</head>
<body>
  <div id="top-bar">
    <div><b>🚗 바다따라 - 해안도로 감성 길찾기</b></div>
    <div id="inputs">
      <input id="start" type="text" placeholder="출발지 주소 또는 장소명" />
      <input id="end" type="text" placeholder="도착지 주소 또는 장소명" />
      <button onclick="searchRoute()">경로 검색</button>
    </div>
  </div>
  <div id="map"></div>
  <script>
    const map = new ol.Map({
      target: "map",
      layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
      view: new ol.View({ center: ol.proj.fromLonLat([127.5, 36.5]), zoom: 7 }),
    });

    let routeLayer;

    function clearLayers() {
      if (routeLayer) map.removeLayer(routeLayer);
    }

    async function geocodeORS(text) {
      const apiKey = "5b3ce3597851110001cf62486d543846e80049df9c7a9e10ecef2953";
      const res = await fetch(
        `https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(text)}&boundary.country=KR`
      );
      const json = await res.json();
      const coords = json.features?.[0]?.geometry?.coordinates;
      return coords || null;
    }

    async function fetchCoastline() {
      const res = await fetch("https://rpwjd99.github.io/coastal-drive/해안선_국가기본도.geojson");
      return await res.json();
    }

    async function tryORS(start, waypoint, end) {
      const apiKey = "5b3ce3597851110001cf62486d543846e80049df9c7a9e10ecef2953";
      try {
        const res = await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
          method: "POST",
          headers: {
            Authorization: apiKey,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ coordinates: [start, waypoint, end] }),
        });
        return res.ok ? await res.json() : null;
      } catch {
        return null;
      }
    }

    function getDistance(a, b) {
      return Math.sqrt((a[0] - b[0]) ** 2 + (a[1] - b[1]) ** 2);
    }

    async function findValidWaypoint(start, end, coastGeoJSON) {
      const startLat = start[1], startLon = start[0];
      const candidates = coastGeoJSON.features.map(f => f.geometry.coordinates).filter(coord => {
        const [lon, lat] = coord;
        return Math.abs(lat - startLat) < 0.1 || Math.abs(lon - startLon) < 0.1;
      }).sort((a, b) => getDistance(start, a) - getDistance(start, b));

      for (const radius of [0.03, 0.05]) {
        for (const wp of candidates) {
          if (getDistance(start, wp) < radius) {
            const route = await tryORS(start, wp, end);
            if (route) return { wp, route };
          }
        }
      }
      return null;
    }

    async function searchRoute() {
      clearLayers();
      const startText = document.getElementById("start").value;
      const endText = document.getElementById("end").value;
      const start = await geocodeORS(startText);
      const end = await geocodeORS(endText);
      if (!start || !end) return alert("출발지 또는 도착지를 정확히 입력해 주세요.");

      const coast = await fetchCoastline();
      const result = await findValidWaypoint(start, end, coast);
      if (!result) return alert("도로 연결 가능한 해안 우회 경유지를 찾지 못했습니다.");

      const features = new ol.format.GeoJSON().readFeatures(result.route, { featureProjection: "EPSG:3857" });
      routeLayer = new ol.layer.Vector({
        source: new ol.source.Vector({ features }),
        style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: "#0077cc", width: 4 }) }),
      });
      map.addLayer(routeLayer);
      map.getView().fit(routeLayer.getSource().getExtent(), { padding: [50, 50, 50, 50] });
    }
  </script>
</body>
</html>
