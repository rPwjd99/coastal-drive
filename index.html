<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>▶ 바다따라 - 해안도로 감성 길찾기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #controls { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; flex-wrap: wrap; }
    #map { width: 100%; height: 90vh; }
    input[type="text"] { width: 240px; padding: 6px; }
    button { padding: 6px 12px; }
  </style>
</head>
<body>
  <div id="controls">
    호출지: <input type="text" id="start" placeholder="예: 세종 한누리대로 2130">
    도착지: <input type="text" id="end" placeholder="예: 속초시 중앙로 183">
    <button onclick="searchRoute()">건항 검색</button>
  </div>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/ol.js"></script>
  <script>
    const apiKey = '5b3ce3597851110001cf62486d543846e80049df9c7a9e10ecef2953';

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([127.5, 36.5]),
        zoom: 7
      })
    });

    const routeLayer = new ol.layer.Vector({
      source: new ol.source.Vector(),
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#0077ff', width: 4 })
      })
    });
    map.addLayer(routeLayer);

    async function geocode(address) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
      const data = await response.json();
      if (data.length > 0) return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
      else throw new Error('Geocoding failed');
    }

    async function searchRoute() {
      const startAddr = document.getElementById('start').value;
      const endAddr = document.getElementById('end').value;
      if (!startAddr || !endAddr) return alert('출발지와 도착지를 입력해주세요.');

      try {
        const startCoord = await geocode(startAddr);
        const endCoord = await geocode(endAddr);

        const body = {
          coordinates: [startCoord, endCoord],
          instructions: false,
          format: 'geojson'
        };

        const res = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
          method: 'POST',
          headers: {
            'Authorization': apiKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const geojson = await res.json();

        const format = new ol.format.GeoJSON();
        const features = format.readFeatures(geojson, {
          featureProjection: map.getView().getProjection()
        });

        routeLayer.getSource().clear();
        routeLayer.getSource().addFeatures(features);

        const extent = routeLayer.getSource().getExtent();
        map.getView().fit(extent, { padding: [20, 20, 20, 20] });
      } catch (err) {
        console.error(err);
        alert('경로 계산 또는 주소 변환 중 오류가 발생했습니다.');
      }
    }
  </script>
</body>
</html>