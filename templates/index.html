<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>해안도로 감성 드라이브 경로 검색</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
    <style>
        body { font-family: sans-serif; padding: 1em; }
        #map { width: 100%; height: 500px; margin-top: 20px; }
        input { width: 80%; padding: 8px; margin: 6px 0; }
        button { padding: 8px 16px; margin: 6px 0; }
        .result { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>해안도로 감성 드라이브 경로 검색</h2>

    <label>출발지 주소 (예: 세종시청 또는 한누리대로 2130):</label><br>
    <input type="text" id="start" placeholder="출발지 주소를 입력하세요"><br>
    <button onclick="geocode('start')">출발지 주소 검색</button>
    <div id="startResult" class="result"></div>

    <label>도착지 주소 (예: 속초시청 또는 중앙로 183):</label><br>
    <input type="text" id="end" placeholder="도착지 주소를 입력하세요"><br>
    <button onclick="geocode('end')">도착지 주소 검색</button>
    <div id="endResult" class="result"></div>

    <button onclick="searchRoute()">🚗 해안도로 경로 검색</button>
    <div id="status" class="result"></div>

    <div id="map"></div>

    <script>
        let startCoord = null;
        let endCoord = null;

        const map = new ol.Map({
            target: 'map',
            layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
            view: new ol.View({
                center: ol.proj.fromLonLat([127.5, 36.5]),
                zoom: 7
            })
        });

        const vectorSource = new ol.source.Vector();
        const vectorLayer = new ol.layer.Vector({ source: vectorSource });
        map.addLayer(vectorLayer);

        function geocode(type) {
            const addr = document.getElementById(type).value;
            fetch('/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr })
            })
            .then(res => res.json())
            .then(data => {
                if (data.lat && data.lon) {
                    document.getElementById(type + 'Result').innerText = `✅ 위치: ${data.lat}, ${data.lon}`;
                    if (type === 'start') startCoord = [data.lon, data.lat];
                    if (type === 'end') endCoord = [data.lon, data.lat];
                } else {
                    document.getElementById(type + 'Result').innerText = `❌ 검색 실패: ${data.error}`;
                }
            });
        }

        function searchRoute() {
            if (!startCoord || !endCoord) {
                document.getElementById("status").innerText = "❗ 출발지와 도착지를 모두 입력하세요.";
                return;
            }

            fetch('/route', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: startCoord, end: endCoord })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("status").innerText = `❌ 경로 요청 실패: ${data.error}`;
                } else {
                    document.getElementById("status").innerText = "✅ 경로 표시 중...";
                    vectorSource.clear();

                    const route = new ol.format.GeoJSON().readFeature(data.route, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    vectorSource.addFeature(route);

                    data.tourspots.forEach(spot => {
                        const marker = new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([spot.mapx, spot.mapy])),
                            name: spot.title
                        });
                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 5,
                                fill: new ol.style.Fill({ color: 'blue' }),
                                stroke: new ol.style.Stroke({ color: 'white', width: 1 })
                            })
                        }));
                        vectorSource.addFeature(marker);
                    });
                }
            });
        }
    </script>
</body>
</html>
