<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>해안 경유 경로 추천</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" rel="stylesheet">
    <style>
        #map { width: 100%; height: 90vh; }
        #controls { margin: 10px; }
    </style>
</head>
<body>
<div id="controls">
    <input type="text" id="start" placeholder="출발지 주소">
    <input type="text" id="end" placeholder="도착지 주소">
    <button onclick="fetchRoute()">🚗 경로 검색</button>
</div>
<div id="map"></div>

<script>
    const map = new ol.Map({
        target: 'map',
        layers: [
            new ol.layer.Tile({ source: new ol.source.OSM() })
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat([127.5, 36.5]),
            zoom: 7
        })
    });

    let routeLayer = null;
    let waypointLayer = null;

    function drawGeoJSON(data, style, clear = true) {
        const format = new ol.format.GeoJSON();
        const features = format.readFeatures(data, {
            featureProjection: 'EPSG:3857'
        });
        const vector = new ol.layer.Vector({
            source: new ol.source.Vector({ features }),
            style
        });
        if (clear && routeLayer) map.removeLayer(routeLayer);
        routeLayer = vector;
        map.addLayer(vector);
    }

    function drawWaypoint(lat, lon) {
        const feature = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])) });
        const vector = new ol.layer.Vector({
            source: new ol.source.Vector({ features: [feature] }),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 7,
                    fill: new ol.style.Fill({ color: 'red' }),
                    stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                })
            })
        });
        if (waypointLayer) map.removeLayer(waypointLayer);
        waypointLayer = vector;
        map.addLayer(vector);
    }

    async function fetchRoute() {
        const start = document.getElementById('start').value;
        const end = document.getElementById('end').value;

        const res = await fetch('/route', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start, end })
        });

        const data = await res.json();

        if (data.error) {
            alert(data.error);
            return;
        }

        const path = data.route?.route?.traoptimal?.[0]?.path;
        const waypoint = data.waypoint;

        if (path) {
            const coords = path.map(p => ol.proj.fromLonLat(p));
            const line = new ol.Feature(new ol.geom.LineString(coords));
            const geojson = new ol.format.GeoJSON().writeFeaturesObject([line]);
            drawGeoJSON(geojson, new ol.style.Style({
                stroke: new ol.style.Stroke({ color: '#0077ff', width: 4 })
            }));
        }

        if (waypoint) {
            drawWaypoint(waypoint[0], waypoint[1]);
        }
    }
</script>
</body>
</html>
