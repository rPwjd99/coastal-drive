<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>바다따라 - 해안도로 경유 드라이브</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
  <style>
    #map { width: 100%; height: 80vh; }
    #search { padding: 1em; background: #fff; }
    input { width: 200px; margin-right: 10px; }
  </style>
</head>
<body>
  <div id="search">
    <input id="start" placeholder="출발지 주소 입력" />
    <input id="end" placeholder="도착지 주소 입력" />
    <button onclick="searchRoute()">해안도로 경유 경로 검색</button>
  </div>
  <div id="map"></div>
  <script>
    const map = new ol.Map({
      target: 'map',
      layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
      view: new ol.View({ center: ol.proj.fromLonLat([127.5, 36.5]), zoom: 7 })
    });

    function drawRoute(coords) {
      const line = new ol.geom.LineString(coords.map(c => ol.proj.fromLonLat(c)));
      const feature = new ol.Feature({ geometry: line });
      const layer = new ol.layer.Vector({
        source: new ol.source.Vector({ features: [feature] }),
        style: new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'blue', width: 4 }) })
      });
      map.addLayer(layer);
      map.getView().fit(line, { padding: [100, 100, 100, 100] });
    }

    function showTourSpots(spots) {
      const features = spots.map(spot => {
        const coord = ol.proj.fromLonLat([spot.lon, spot.lat]);
        const marker = new ol.Feature({ geometry: new ol.geom.Point(coord) });
        marker.setStyle(new ol.style.Style({
          image: new ol.style.Circle({ radius: 6, fill: new ol.style.Fill({ color: 'red' }) })
        }));
        marker.set('desc', `<b>${spot.title}</b><br>${spot.addr}<br><img src="${spot.image}" width="100" />`);
        return marker;
      });

      const layer = new ol.layer.Vector({
        source: new ol.source.Vector({ features }),
      });

      map.addLayer(layer);

      const overlay = new ol.Overlay({ element: document.createElement('div'), positioning: 'bottom-center', offset: [0, -10], autoPan: true });
      map.addOverlay(overlay);
      map.on('click', function (e) {
        map.forEachFeatureAtPixel(e.pixel, function (feature) {
          const element = overlay.getElement();
          element.innerHTML = feature.get('desc');
          element.style.background = 'white';
          element.style.border = '1px solid #ccc';
          element.style.padding = '10px';
          overlay.setPosition(e.coordinate);
        });
      });
    }

    async function searchRoute() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const res = await fetch('/api/route', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start, end })
      });
      const data = await res.json();
      if (data.route) {
        const coords = data.route.features[0].geometry.coordinates.map(c => [c[0], c[1]]);
        drawRoute(coords);
        const endCoord = coords[coords.length - 1];
        const spotRes = await fetch('/api/tourspot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lat: endCoord[1], lon: endCoord[0] })
        });
        const spots = await spotRes.json();
        showTourSpots(spots);
      } else {
        alert('경로 검색 실패: ' + (data.error || '서버 오류'));
      }
    }
  </script>
</body>
</html>
