<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•´ì•ˆë„ë¡œ ê°ì„± ë“œë¼ì´ë¸Œ ê²½ë¡œ ê²€ìƒ‰</title>
    <style>
        body { font-family: sans-serif; padding: 1rem; }
        .controls { margin-bottom: 1rem; background: #f0f0f0; padding: 1rem; border-radius: 8px; }
        #map { width: 100%; height: 600px; }
        input, button { padding: 0.5rem; margin: 0.2rem 0; width: 100%; }
    </style>
</head>
<body>
    <h2>í•´ì•ˆë„ë¡œ ê°ì„± ë“œë¼ì´ë¸Œ ê²½ë¡œ ê²€ìƒ‰</h2>

    <div class="controls">
        <label>ì¶œë°œì§€ ì£¼ì†Œ (ì˜ˆ: ì„¸ì¢…ì‹œì²­ ë˜ëŠ” í•œëˆ„ë¦¬ëŒ€ë¡œ 2130):</label>
        <input type="text" id="start" placeholder="ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ í•œëˆ„ë¦¬ëŒ€ë¡œ 2130">
        <label>ë„ì°©ì§€ ì£¼ì†Œ (ì˜ˆ: ì†ì´ˆì‹œì²­ ë˜ëŠ” ì¤‘ì•™ë¡œ 183):</label>
        <input type="text" id="end" placeholder="ê°•ì›ë„ ì†ì´ˆì‹œ ì¤‘ì•™ë¡œ 183">
        <button onclick="searchRoute()">í•´ì•ˆë„ë¡œ ê²½ë¡œ ê²€ìƒ‰</button>
        <p id="status"></p>
    </div>

    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">

    <script>
        let map = new ol.Map({
            target: 'map',
            layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
            view: new ol.View({ center: ol.proj.fromLonLat([127.5, 36.5]), zoom: 7 })
        });

        async function geocode(address) {
            const res = await fetch("/geocode", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address })
            });
            if (!res.ok) throw new Error("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return await res.json();
        }

        async function searchRoute() {
            const startAddr = document.getElementById("start").value;
            const endAddr = document.getElementById("end").value;
            const status = document.getElementById("status");

            try {
                status.textContent = "ğŸ“ ì£¼ì†Œ ë³€í™˜ ì¤‘...";
                const start = await geocode(startAddr);
                const end = await geocode(endAddr);

                status.textContent = "ğŸ›£ï¸ í•´ì•ˆë„ë¡œ ê²½ìœ  ê²½ë¡œ ê³„ì‚° ì¤‘...";
                const res = await fetch("/route", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ start, end })
                });

                const data = await res.json();
                if (!res.ok) {
                    status.textContent = "âŒ " + (data.error || "ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨");
                    console.error(data.details);
                    return;
                }

                status.textContent = "âœ… ê²½ë¡œ í‘œì‹œ ì™„ë£Œ!";
                drawRoute(data);
            } catch (err) {
                status.textContent = "âŒ ì—ëŸ¬ ë°œìƒ: " + err.message;
            }
        }

        function drawRoute(geojson) {
            const format = new ol.format.GeoJSON();
            const feature = format.readFeature(geojson, {
                featureProjection: 'EPSG:3857'
            });

            const layer = new ol.layer.Vector({
                source: new ol.source.Vector({ features: [feature] }),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({ color: 'blue', width: 4 })
                })
            });

            map.getLayers().getArray().slice(1).forEach(l => map.removeLayer(l));
            map.addLayer(layer);
            map.getView().fit(layer.getSource().getExtent(), { padding: [50, 50, 50, 50] });
        }
    </script>
</body>
</html>
