<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë°”ë‹¤ë”°ë¼ ğŸŒŠ í•´ì•ˆë„ë¡œ ê²½ë¡œ ì¶”ì²œ</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #map { width: 100%; height: 500px; margin-top: 15px; border: 1px solid #ccc; }
    input { width: 300px; padding: 6px; margin: 5px; }
    button { padding: 6px 12px; }
    #status { margin-top: 10px; color: #555; }
  </style>
</head>
<body>
  <h2>ğŸš— ë°”ë‹¤ë”°ë¼: í•´ì•ˆë„ë¡œ ê°ì„± ë“œë¼ì´ë¸Œ ì½”ìŠ¤</h2>

  <input type="text" id="start" placeholder="ì¶œë°œì§€ ì˜ˆ: ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œì²­" />
  <input type="text" id="end" placeholder="ë„ì°©ì§€ ì˜ˆ: ì†ì´ˆì‹œì²­" />
  <button onclick="searchRoute()">í•´ì•ˆë„ë¡œ ê²½ë¡œ ê²€ìƒ‰</button>
  <div id="status">â³ ì¤€ë¹„ ì¤‘...</div>

  <div id="map"></div>

  <script>
    let map, vectorLayer;

    function initMap() {
      vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector()
      });

      map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({ source: new ol.source.OSM() }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([127.5, 36.5]),
          zoom: 7
        })
      });
    }

    function drawGeoJSON(geojson, tourspots) {
      const format = new ol.format.GeoJSON();
      const features = format.readFeatures(geojson, {
        featureProjection: 'EPSG:3857'
      });

      vectorLayer.getSource().clear();
      vectorLayer.getSource().addFeatures(features);

      // ê´€ê´‘ì§€ ë§ˆì»¤
      tourspots.forEach((spot) => {
        const feature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.fromLonLat([spot.mapx, spot.mapy])),
          name: spot.title,
          desc: spot.addr1
        });

        feature.setStyle(new ol.style.Style({
          image: new ol.style.Icon({
            src: 'https://maps.google.com/mapfiles/kml/shapes/info-i_maps.png',
            scale: 0.7
          })
        }));

        vectorLayer.getSource().addFeature(feature);
      });

      map.getView().fit(vectorLayer.getSource().getExtent(), { padding: [50, 50, 50, 50] });
    }

    async function searchRoute() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const status = document.getElementById('status');

      if (!start || !end) {
        status.textContent = "â— ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }

      status.textContent = "â³ ê²½ë¡œë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...";

      try {
        const response = await fetch('/route', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ start, end })
        });

        const result = await response.json();

        if (response.ok) {
          drawGeoJSON(result.geojson, result.tourspots);
          status.textContent = `âœ… ê²½ë¡œ ê³„ì‚° ì„±ê³µ! ìš°íšŒì§€ì : ${result.waypoint}`;
        } else {
          status.textContent = "âŒ ì„œë²„ ì˜¤ë¥˜: " + result.error;
        }
      } catch (err) {
        console.error(err);
        status.textContent = "âŒ ì˜ˆì™¸ ë°œìƒ: ì„œë²„ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
      }
    }

    initMap();
  </script>
</body>
</html>
