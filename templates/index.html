<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í•´ì•ˆë„ë¡œ ê°ì„± ë“œë¼ì´ë¸Œ ê²½ë¡œ ê²€ìƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
    <style>
        body { font-family: sans-serif; padding: 1em; }
        #map { width: 100%; height: 500px; margin-top: 20px; }
        input { width: 80%; padding: 8px; margin: 6px 0; }
        button { padding: 8px 16px; margin: 6px 0; }
        .result { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>í•´ì•ˆë„ë¡œ ê°ì„± ë“œë¼ì´ë¸Œ ê²½ë¡œ ê²€ìƒ‰</h2>

    <label>ì¶œë°œì§€ ì£¼ì†Œ (ì˜ˆ: ì„¸ì¢…ì‹œì²­ ë˜ëŠ” í•œëˆ„ë¦¬ëŒ€ë¡œ 2130):</label><br>
    <input type="text" id="start" placeholder="ì¶œë°œì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"><br>
    <button onclick="geocode('start')">ì¶œë°œì§€ ì£¼ì†Œ ê²€ìƒ‰</button>
    <div id="startResult" class="result"></div>

    <label>ë„ì°©ì§€ ì£¼ì†Œ (ì˜ˆ: ì†ì´ˆì‹œì²­ ë˜ëŠ” ì¤‘ì•™ë¡œ 183):</label><br>
    <input type="text" id="end" placeholder="ë„ì°©ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"><br>
    <button onclick="geocode('end')">ë„ì°©ì§€ ì£¼ì†Œ ê²€ìƒ‰</button>
    <div id="endResult" class="result"></div>

    <button onclick="searchRoute()">ğŸš— í•´ì•ˆë„ë¡œ ê²½ë¡œ ê²€ìƒ‰</button>
    <div id="status" class="result"></div>

    <div id="map"></div>

    <script>
        let startCoord = null;
        let endCoord = null;

        const map = new ol.Map({
            target: 'map',
            layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
            view: new ol.View({
                center: ol.proj.fromLonLat([127.5, 36.5]),
                zoom: 7
            })
        });

        const vectorSource = new ol.source.Vector();
        const vectorLayer = new ol.layer.Vector({ source: vectorSource });
        map.addLayer(vectorLayer);

        function geocode(type) {
            const addr = document.getElementById(type).value;
            fetch('/geocode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address: addr })
            })
            .then(res => res.json())
            .then(data => {
                if (data.lat && data.lon) {
                    document.getElementById(type + 'Result').innerText = `âœ… ìœ„ì¹˜: ${data.lat}, ${data.lon}`;
                    if (type === 'start') startCoord = [data.lon, data.lat];
                    if (type === 'end') endCoord = [data.lon, data.lat];
                } else {
                    document.getElementById(type + 'Result').innerText = `âŒ ê²€ìƒ‰ ì‹¤íŒ¨: ${data.error}`;
                }
            });
        }

        function searchRoute() {
            if (!startCoord || !endCoord) {
                document.getElementById("status").innerText = "â— ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.";
                return;
            }

            fetch('/route', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: startCoord, end: endCoord })
            })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    document.getElementById("status").innerText = `âŒ ê²½ë¡œ ìš”ì²­ ì‹¤íŒ¨: ${data.error}`;
                } else {
                    document.getElementById("status").innerText = "âœ… ê²½ë¡œ í‘œì‹œ ì¤‘...";
                    vectorSource.clear();

                    const route = new ol.format.GeoJSON().readFeature(data.route, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    vectorSource.addFeature(route);

                    data.tourspots.forEach(spot => {
                        const marker = new ol.Feature({
                            geometry: new ol.geom.Point(ol.proj.fromLonLat([spot.mapx, spot.mapy])),
                            name: spot.title
                        });
                        marker.setStyle(new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 5,
                                fill: new ol.style.Fill({ color: 'blue' }),
                                stroke: new ol.style.Stroke({ color: 'white', width: 1 })
                            })
                        }));
                        vectorSource.addFeature(marker);
                    });
                }
            });
        }
    </script>
</body>
</html>
