<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Coastal Drive 경로 검색</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css">
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
        }
        #controls {
            padding: 1rem;
            background: #f4f4f4;
        }
        #map {
            width: 100%;
            height: 90vh;
        }
        label, input, button {
            margin: 0.5rem 0;
            display: block;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="start">출발지 주소:</label>
        <input type="text" id="start" placeholder="예: 세종특별자치시 한누리대로 2130">
        
        <label for="end">도착지 주소:</label>
        <input type="text" id="end" placeholder="예: 강원도 속초시 중앙로 183">
        
        <button onclick="searchRoute()">해안도로 경로 검색</button>
    </div>
    <div id="map"></div>

    <script>
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([127.5, 36.2]),
                zoom: 7
            })
        });

        let routeLayer;
        let touristLayer;

        function drawGeoJSON(data, isTourist = false) {
            const format = new ol.format.GeoJSON();
            const feature = format.readFeatures(data, {
                featureProjection: 'EPSG:3857'
            });
            const layer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: feature
                }),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: isTourist ? 'green' : 'blue',
                        width: 4
                    }),
                    image: isTourist ? new ol.style.Circle({
                        radius: 6,
                        fill: new ol.style.Fill({ color: 'orange' })
                    }) : undefined
                })
            });

            if (isTourist) {
                if (touristLayer) map.removeLayer(touristLayer);
                touristLayer = layer;
            } else {
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = layer;
            }
            map.addLayer(layer);
            map.getView().fit(layer.getSource().getExtent(), { padding: [20, 20, 20, 20], maxZoom: 12 });
        }

        async function searchRoute() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            if (!start || !end) {
                alert("출발지와 도착지를 모두 입력하세요.");
                return;
            }

            try {
                const res = await fetch(`/api/route?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
                const data = await res.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                drawGeoJSON(data.route);
                if (data.tourspots) drawGeoJSON(data.tourspots, true);
            } catch (err) {
                alert("서버 오류 또는 주소 해석 실패");
                console.error(err);
            }
        }
    </script>
</body>
</html>
