<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>바다따라 🌊 해안도로 경로 추천</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/ol.css" />
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #map { width: 100%; height: 500px; margin-top: 15px; border: 1px solid #ccc; }
    input { width: 300px; padding: 6px; margin: 5px; }
    button { padding: 6px 12px; }
    #status { margin-top: 10px; color: #555; }
  </style>
</head>
<body>
  <h2>🚗 바다따라: 해안도로 감성 드라이브 코스</h2>

  <input type="text" id="start" placeholder="출발지 예: 세종특별자치시청" />
  <input type="text" id="end" placeholder="도착지 예: 속초시청" />
  <button onclick="searchRoute()">해안도로 경로 검색</button>
  <div id="status">⏳ 준비 중...</div>

  <div id="map"></div>

  <script>
    let map, vectorLayer;

    function initMap() {
      vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector()
      });

      map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({ source: new ol.source.OSM() }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([127.5, 36.5]),
          zoom: 7
        })
      });
    }

    function drawGeoJSON(geojson, tourspots) {
      const format = new ol.format.GeoJSON();
      const features = format.readFeatures(geojson, {
        featureProjection: 'EPSG:3857'
      });

      vectorLayer.getSource().clear();
      vectorLayer.getSource().addFeatures(features);

      // 관광지 마커
      tourspots.forEach((spot) => {
        const feature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.fromLonLat([spot.mapx, spot.mapy])),
          name: spot.title,
          desc: spot.addr1
        });

        feature.setStyle(new ol.style.Style({
          image: new ol.style.Icon({
            src: 'https://maps.google.com/mapfiles/kml/shapes/info-i_maps.png',
            scale: 0.7
          })
        }));

        vectorLayer.getSource().addFeature(feature);
      });

      map.getView().fit(vectorLayer.getSource().getExtent(), { padding: [50, 50, 50, 50] });
    }

    async function searchRoute() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;
      const status = document.getElementById('status');

      if (!start || !end) {
        status.textContent = "❗ 출발지와 도착지를 모두 입력해주세요.";
        return;
      }

      status.textContent = "⏳ 경로를 계산 중입니다...";

      try {
        const response = await fetch('/route', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ start, end })
        });

        const result = await response.json();

        if (response.ok) {
          drawGeoJSON(result.geojson, result.tourspots);
          status.textContent = `✅ 경로 계산 성공! 우회지점: ${result.waypoint}`;
        } else {
          status.textContent = "❌ 서버 오류: " + result.error;
        }
      } catch (err) {
        console.error(err);
        status.textContent = "❌ 예외 발생: 서버 또는 네트워크 오류. 콘솔을 확인하세요.";
      }
    }

    initMap();
  </script>
</body>
</html>
