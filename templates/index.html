<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>해안도로 감성 드라이브</title>
  <script src="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.3.0/dist/ol.css">
  <style>
    body { font-family: sans-serif; padding: 1em; }
    input { margin: 0.3em; width: 400px; }
    #map { width: 100%; height: 500px; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>해안도로 감성 드라이브 경로 검색</h2>
  출발지 주소 (예: 세종시청 또는 한누리대로 2130):<br>
  <input id="start" placeholder="세종특별자치시 한누리대로 2130"><br>
  도착지 주소 (예: 속초시청 또는 중앙로 183):<br>
  <input id="end" placeholder="강원도 속초시 중앙로 183"><br>
  <button onclick="searchRoute()">해안도로 경로 검색</button>
  <div id="status"></div>
  <div id="map"></div>

  <script>
    async function geocode(addr) {
      const res = await fetch("https://maps.googleapis.com/maps/api/geocode/json?address=" + encodeURIComponent(addr) + "&key=AIzaSyC9MSD-WhkqK_Og5YdVYfux21xiRjy2q1M");
      const data = await res.json();
      if (data.status === "OK") {
        const loc = data.results[0].geometry.location;
        return [loc.lat, loc.lng];
      } else {
        throw new Error("검색 실패");
      }
    }

    async function searchRoute() {
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      document.getElementById("status").innerText = "검색 중...";
      try {
        const startCoord = await geocode(start);
        const endCoord = await geocode(end);
        const res = await fetch("/route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start: startCoord, end: endCoord })
        });
        const data = await res.json();
        if (data.error) {
          document.getElementById("status").innerText = "❌ " + data.error;
        } else {
          drawRoute(data);
          document.getElementById("status").innerText = "✅ 경로 완료";
        }
      } catch (err) {
        document.getElementById("status").innerText = "❌ " + err.message;
      }
    }

    let map = new ol.Map({
      target: 'map',
      layers: [new ol.layer.Tile({source: new ol.source.OSM()})],
      view: new ol.View({center: ol.proj.fromLonLat([127.3, 36.5]), zoom: 7})
    });

    function drawRoute(geojson) {
      const format = new ol.format.GeoJSON();
      const feature = format.readFeature(geojson, {featureProjection: "EPSG:3857"});
      const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({features: [feature]}),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({color: "blue", width: 4})
        })
      });
      map.getLayers().getArray().slice(1).forEach(l => map.removeLayer(l));
      map.addLayer(vectorLayer);
      map.getView().fit(feature.getGeometry(), {padding: [20, 20, 20, 20]});
    }
  </script>
</body>
</html>
